// Schéma de données pour l'Observatoire des Mines de Madagascar (MOM)
// Basé sur le cahier des charges TIMG_MOM_TdR_Conception-Web.md
// Technologies: Prisma ORM + PostgreSQL

generator client {
  provider      = "prisma-client-js"
  // Utiliser l'emplacement par defaut pour une meilleure compatibilite ESM
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// GESTION DES UTILISATEURS (Back-office)
// ============================================================================

enum UserRole {
  ADMIN      // Administrateur - accès complet
  EDITOR     // Éditeur - gestion du contenu
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  firstName     String
  lastName      String
  role          UserRole  @default(EDITOR)
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  caseStudies   CaseStudy[]   @relation("CaseStudyAuthor")
  newsArticles  News[]        @relation("NewsAuthor")
  resources     Resource[]    @relation("ResourceAuthor")

  @@map("users")
}

// ============================================================================
// ÉTUDES DE CAS (Élément central du site)
// ============================================================================

model CaseStudy {
  id              String    @id @default(cuid())
  slug            String    @unique // URL-friendly identifier
  title           String    // Nom du cas
  subtitle        String?   // Sous-titre résumant le contexte
  summary         String    // Court résumé (pour les cartes)
  content         String    @db.Text // Description détaillée (HTML/Markdown)
  coverImage      String?   // Image de couverture (URL ou chemin)
  eventDate       DateTime? // Date de l'événement
  location        String?   // Lieu précis
  isPublished     Boolean   @default(false)
  publishedAt     DateTime?
  viewCount       Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  authorId        String
  author          User      @relation("CaseStudyAuthor", fields: [authorId], references: [id])
  regionId        String?
  region          Region?   @relation(fields: [regionId], references: [id])
  categories      CaseStudyCategory[]
  media           CaseStudyMedia[]
  keywords        CaseStudyKeyword[]

  @@index([publishedAt])
  @@index([regionId])
  @@map("case_studies")
}

// Table pivot pour les catégories des études de cas
model CaseStudyCategory {
  caseStudyId String
  categoryId  String
  caseStudy   CaseStudy @relation(fields: [caseStudyId], references: [id], onDelete: Cascade)
  category    Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([caseStudyId, categoryId])
  @@map("case_study_categories")
}

// Médias associés aux études de cas (photos, vidéos, documents)
model CaseStudyMedia {
  id          String    @id @default(cuid())
  caseStudyId String
  caseStudy   CaseStudy @relation(fields: [caseStudyId], references: [id], onDelete: Cascade)
  mediaId     String
  media       Media     @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  caption     String?   // Légende optionnelle
  sortOrder   Int       @default(0)

  @@index([caseStudyId])
  @@map("case_study_media")
}

// Table pivot pour les mots-clés des études de cas
model CaseStudyKeyword {
  caseStudyId String
  keywordId   String
  caseStudy   CaseStudy @relation(fields: [caseStudyId], references: [id], onDelete: Cascade)
  keyword     Keyword   @relation(fields: [keywordId], references: [id], onDelete: Cascade)

  @@id([caseStudyId, keywordId])
  @@map("case_study_keywords")
}

// ============================================================================
// MOTS-CLÉS / TAGS
// ============================================================================

model Keyword {
  id          String    @id @default(cuid())
  name        String    @unique
  slug        String    @unique
  description String?
  icon        String?   // Nom de l'icône FontAwesome ou URL
  color       String?   // Couleur associée (hex)
  sortOrder   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  caseStudies CaseStudyKeyword[]

  @@map("keywords")
}

// ============================================================================
// CATÉGORIES / THÉMATIQUES
// ============================================================================

model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  slug        String    @unique
  description String?
  icon        String?   // Nom de l'icône FontAwesome ou URL
  color       String?   // Couleur associée (hex)
  sortOrder   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  caseStudies CaseStudyCategory[]

  @@map("categories")
}

// ============================================================================
// RÉGIONS DE MADAGASCAR
// ============================================================================

model Region {
  id          String    @id @default(cuid())
  name        String    @unique
  code        String?   @unique // Code région
  description String?
  createdAt   DateTime  @default(now())

  // Relations
  caseStudies CaseStudy[]

  @@map("regions")
}

// ============================================================================
// ACTUALITÉS
// ============================================================================

enum NewsLabel {
  STANDARD  // Pas d'étiquette spéciale (section "Récent")
  TRENDING  // "À la une"
  FEATURED  // "En vedette"
}

model News {
  id          String    @id @default(cuid())
  slug        String    @unique
  title       String
  summary     String    // Court texte descriptif
  content     String    @db.Text // Contenu complet
  coverImage  String?   // Image d'illustration
  externalUrl String?   // Lien externe (bouton "view")
  isPublished Boolean   @default(false)
  publishedAt DateTime?
  viewCount   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Système d'étiquettes avec expiration
  label          NewsLabel @default(STANDARD)
  labelExpiresAt DateTime? // Date d'expiration de l'étiquette

  // Relations
  authorId    String
  author      User      @relation("NewsAuthor", fields: [authorId], references: [id])
  attachments NewsAttachment[]

  @@index([publishedAt])
  @@index([label])
  @@map("news")
}

// Fichiers annexes des actualités (PDF, documents, etc.)
model NewsAttachment {
  id          String   @id @default(cuid())
  newsId      String
  news        News     @relation(fields: [newsId], references: [id], onDelete: Cascade)
  filename    String   // Nom original du fichier
  filepath    String   // Chemin de stockage
  url         String   // URL publique
  mimeType    String
  fileSize    Int      // Taille en octets
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())

  @@index([newsId])
  @@map("news_attachments")
}

// ============================================================================
// RESSOURCES TÉLÉCHARGEABLES (Guides, Recherches, Rapports)
// ============================================================================

model ResourceCategory {
  id          String     @id @default(cuid())
  name        String     @unique
  slug        String     @unique
  description String?
  icon        String?    // Nom FontAwesome (ex: "book") ou URL d'image
  color       String?    // Couleur en hexadécimal (ex: "#3B82F6")
  sortOrder   Int        @default(0)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  resources   Resource[]

  @@map("resource_categories")
}

model Resource {
  id            String            @id @default(cuid())
  slug          String            @unique
  title         String
  description   String?           @db.Text
  coverImage    String?           // Image de couverture
  fileUrl       String            // URL du fichier à télécharger
  filename      String            // Nom original du fichier
  mimeType      String
  fileSize      Int               // Taille en octets
  isPublished   Boolean           @default(false)
  publishedAt   DateTime?
  downloadCount Int               @default(0)
  sortOrder     Int               @default(0)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  // Relations
  categoryId    String?
  category      ResourceCategory? @relation(fields: [categoryId], references: [id])
  authorId      String
  author        User              @relation("ResourceAuthor", fields: [authorId], references: [id])

  @@index([publishedAt])
  @@index([categoryId])
  @@map("resources")
}

// ============================================================================
// AXES STRATÉGIQUES ET MISSIONS
// ============================================================================

model StrategicAxis {
  id              String    @id @default(cuid())
  title           String
  description     String    // Court texte explicatif
  icon            String?   // Nom FontAwesome (ex: "eye") ou URL d'image (ex: "/uploads/icon.png")
  color           String?   // Couleur en hexadécimal (ex: "#3695d8")
  backgroundImage String?   // Image de fond
  linkUrl         String?   // Lien vers page "À propos" ou autre
  sortOrder       Int       @default(0)
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("strategic_axes")
}

// ============================================================================
// PARTENAIRES
// ============================================================================

model Partner {
  id          String    @id @default(cuid())
  name        String
  logo        String    // URL ou chemin du logo
  websiteUrl  String?   // Lien vers leur site web
  description String?
  sortOrder   Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("partners")
}

// ============================================================================
// GALERIE D'IMAGES (Slider page d'accueil)
// ============================================================================

model GalleryImage {
  id          String    @id @default(cuid())
  title       String?
  description String?
  imageUrl    String
  linkUrl     String?   // Lien optionnel au clic
  sortOrder   Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("gallery_images")
}

// ============================================================================
// GESTION DES MÉDIAS (Fichiers uploadés)
// ============================================================================

enum MediaType {
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT // PDF, etc.
}

model Media {
  id            String    @id @default(cuid())
  filename      String    // Nom original du fichier
  filepath      String    // Chemin de stockage
  url           String    // URL publique
  mimeType      String
  mediaType     MediaType
  fileSize      Int       // Taille en octets
  width         Int?      // Pour les images/vidéos
  height        Int?      // Pour les images/vidéos
  duration      Int?      // Pour audio/vidéo (en secondes)
  altText       String?   // Texte alternatif (accessibilité)
  downloadCount Int       @default(0)
  createdAt     DateTime  @default(now())

  // Relations
  caseStudies   CaseStudyMedia[]

  @@index([mediaType])
  @@map("media")
}

// ============================================================================
// SIGNALEMENT DE CAS / CONTACT
// ============================================================================

enum ContactStatus {
  NEW
  IN_REVIEW
  PROCESSED
  ARCHIVED
}

model Contact {
  id          String        @id @default(cuid())
  name        String?
  email       String?
  phone       String?
  subject     String
  message     String        @db.Text
  status      ContactStatus @default(NEW)
  isAnonymous Boolean       @default(false)
  ipAddress   String?
  createdAt   DateTime      @default(now())
  processedAt DateTime?
  notes       String?       @db.Text // Notes internes

  @@index([status])
  @@index([createdAt])
  @@map("contacts")
}

// ============================================================================
// STATISTIQUES ET SUIVI
// ============================================================================

model PageVisit {
  id          String    @id @default(cuid())
  path        String    // URL de la page visitée
  referrer    String?   // Page de provenance
  userAgent   String?
  ipAddress   String?
  country     String?
  city        String?
  visitedAt   DateTime  @default(now())

  @@index([path])
  @@index([visitedAt])
  @@map("page_visits")
}

model Download {
  id          String    @id @default(cuid())
  mediaId     String
  ipAddress   String?
  userAgent   String?
  downloadedAt DateTime @default(now())

  @@index([mediaId])
  @@index([downloadedAt])
  @@map("downloads")
}

// ============================================================================
// CONFIGURATION DU SITE
// ============================================================================

model SiteConfig {
  id          String    @id @default(cuid())
  key         String    @unique
  value       String    @db.Text
  description String?
  updatedAt   DateTime  @updatedAt

  @@map("site_config")
}

// ============================================================================
// CONTENU DE LA PAGE "À PROPOS"
// ============================================================================

model AboutContent {
  id          String    @id @default(cuid())
  section     String    @unique // Slug généré à partir du titre
  title       String
  content     String    @db.Text // Contenu EditorJS (JSON) ou HTML
  image       String?
  sortOrder   Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([sortOrder])
  @@map("about_content")
}

// ============================================================================
// ÉVÉNEMENTS HISTORIQUES (Timeline "À propos")
// ============================================================================

model TimelineEvent {
  id          String   @id @default(cuid())
  year        String   // Ex: "2000", "2006"
  title       String
  description String   @db.Text
  image       String?  // Image optionnelle pour l'événement
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("timeline_events")
}
